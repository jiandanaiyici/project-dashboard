# 技术实现方案

## 1. 前端架构设计

### 1.1 项目结构
```
src/
├── components/          # 通用组件
│   ├── charts/         # 图表组件
│   ├── forms/          # 表单组件
│   ├── tables/         # 表格组件
│   └── layout/         # 布局组件
├── pages/              # 页面组件
│   ├── dashboard/      # 仪表盘
│   ├── projects/       # 项目管理
│   ├── personnel/      # 人员管理
│   ├── monitoring/     # 性能监控
│   └── analytics/      # 数据分析
├── hooks/              # 自定义Hooks
├── services/           # API服务
├── store/              # 状态管理
├── utils/              # 工具函数
├── types/              # TypeScript类型定义
└── constants/          # 常量定义
```

### 1.2 核心组件设计

#### 1.2.1 仪表盘组件
- **DashboardLayout**: 主布局组件
- **MetricCard**: 指标卡片组件
- **ChartContainer**: 图表容器组件
- **RealTimeMonitor**: 实时监控组件

#### 1.2.2 图表组件库
- **RingChart**: 环形图组件
- **TrendChart**: 趋势图组件
- **DistributionChart**: 分布图组件
- **HeatmapChart**: 热力图组件
- **GaugeChart**: 仪表盘组件

#### 1.2.3 数据表格组件
- **DataTable**: 通用数据表格
- **SortableTable**: 可排序表格
- **FilterableTable**: 可筛选表格
- **EditableTable**: 可编辑表格

## 2. 状态管理设计

### 2.1 Redux Store结构
```typescript
interface RootState {
  auth: AuthState;           // 用户认证状态
  user: UserState;           // 用户信息
  projects: ProjectState;    // 项目数据
  personnel: PersonnelState; // 人员数据
  monitoring: MonitoringState; // 监控数据
  analytics: AnalyticsState; // 分析数据
  ui: UIState;              // UI状态
}
```

### 2.2 核心Slice设计

#### 2.2.1 项目管理Slice
```typescript
interface ProjectState {
  projects: Project[];
  currentProject: Project | null;
  loading: boolean;
  error: string | null;
  filters: ProjectFilters;
  pagination: PaginationState;
}
```

#### 2.2.2 人员管理Slice
```typescript
interface PersonnelState {
  users: User[];
  currentUser: User | null;
  evaluations: Evaluation[];
  movements: PersonnelMovement[];
  statistics: PersonnelStatistics;
  loading: boolean;
  error: string | null;
}
```

## 3. API服务设计

### 3.1 服务层架构
```typescript
// services/api.ts
class ApiService {
  private baseURL: string;
  private token: string;
  
  // 项目管理API
  async getProjects(filters?: ProjectFilters): Promise<Project[]>
  async createProject(project: CreateProjectRequest): Promise<Project>
  async updateProject(id: string, project: UpdateProjectRequest): Promise<Project>
  async deleteProject(id: string): Promise<void>
  
  // 人员管理API
  async getUsers(filters?: UserFilters): Promise<User[]>
  async createUser(user: CreateUserRequest): Promise<User>
  async updateUser(id: string, user: UpdateUserRequest): Promise<User>
  async deleteUser(id: string): Promise<void>
  async evaluateUser(userId: string, evaluation: EvaluationRequest): Promise<Evaluation>
  
  // 监控数据API
  async getPerformanceMetrics(appId: string, timeRange: TimeRange): Promise<PerformanceMetrics>
  async getErrorLogs(appId: string, filters?: ErrorFilters): Promise<ErrorLog[]>
  async getSourceMapMapping(errorId: string): Promise<SourceMapMapping>
  
  // 分析数据API
  async getAnalyticsData(query: AnalyticsQuery): Promise<AnalyticsData>
  async getTrendData(metric: string, timeRange: TimeRange): Promise<TrendData>
  async getDistributionData(dimension: string): Promise<DistributionData>
}
```

### 3.2 数据模型定义
```typescript
// types/models.ts
interface Project {
  id: string;
  name: string;
  description: string;
  status: ProjectStatus;
  startDate: Date;
  endDate: Date;
  manager: User;
  team: User[];
  applications: Application[];
  metrics: ProjectMetrics;
}

interface User {
  id: string;
  name: string;
  email: string;
  role: UserRole;
  department: string;
  skills: string[];
  currentProjects: string[];
  evaluations: Evaluation[];
  performance: PerformanceMetrics;
}

interface PerformanceMetrics {
  responseTime: number;
  errorRate: number;
  availability: number;
  throughput: number;
  pv: number;
  uv: number;
  conversionRate: number;
}

interface Evaluation {
  id: string;
  userId: string;
  evaluatorId: string;
  projectId: string;
  technicalSkills: number;
  workAttitude: number;
  teamwork: number;
  projectContribution: number;
  knowledgeTransfer: number;
  overallScore: number;
  comments: string;
  createdAt: Date;
}
```

## 4. 图表组件实现

### 4.1 环形图组件
```typescript
// components/charts/RingChart.tsx
import React from 'react';
import { Pie } from '@ant-design/charts';

interface RingChartProps {
  data: Array<{ name: string; value: number; color?: string }>;
  title?: string;
  height?: number;
  showLegend?: boolean;
}

const RingChart: React.FC<RingChartProps> = ({
  data,
  title,
  height = 300,
  showLegend = true
}) => {
  const config = {
    data,
    angleField: 'value',
    colorField: 'name',
    radius: 0.8,
    innerRadius: 0.6,
    label: {
      type: 'inner',
      offset: '-50%',
      content: '{value}',
      style: {
        textAlign: 'center',
        fontSize: 14,
      },
    },
    legend: showLegend ? {
      position: 'bottom' as const,
    } : false,
    interactions: [
      {
        type: 'element-active',
      },
    ],
  };

  return (
    <div className="ring-chart">
      {title && <h3 className="chart-title">{title}</h3>}
      <Pie {...config} height={height} />
    </div>
  );
};
```

### 4.2 趋势图组件
```typescript
// components/charts/TrendChart.tsx
import React from 'react';
import { Line } from '@ant-design/charts';

interface TrendChartProps {
  data: Array<{ date: string; value: number; category?: string }>;
  title?: string;
  height?: number;
  xField?: string;
  yField?: string;
  seriesField?: string;
  smooth?: boolean;
}

const TrendChart: React.FC<TrendChartProps> = ({
  data,
  title,
  height = 300,
  xField = 'date',
  yField = 'value',
  seriesField,
  smooth = true
}) => {
  const config = {
    data,
    xField,
    yField,
    seriesField,
    smooth,
    point: {
      size: 3,
      shape: 'circle',
    },
    tooltip: {
      formatter: (datum: any) => {
        return {
          name: datum[seriesField || yField],
          value: datum[yField],
        };
      },
    },
    legend: seriesField ? {
      position: 'top' as const,
    } : false,
  };

  return (
    <div className="trend-chart">
      {title && <h3 className="chart-title">{title}</h3>}
      <Line {...config} height={height} />
    </div>
  );
};
```

## 5. 性能监控集成

### 5.1 性能监控Hook
```typescript
// hooks/usePerformanceMonitoring.ts
import { useEffect, useState } from 'react';

interface PerformanceMetrics {
  fcp: number; // First Contentful Paint
  lcp: number; // Largest Contentful Paint
  fid: number; // First Input Delay
  cls: number; // Cumulative Layout Shift
  ttfb: number; // Time to First Byte
  fmp: number; // First Meaningful Paint
}

export const usePerformanceMonitoring = (appId: string) => {
  const [metrics, setMetrics] = useState<PerformanceMetrics | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const collectMetrics = () => {
      // 收集Web Vitals
      const observer = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const newMetrics: Partial<PerformanceMetrics> = {};
        
        entries.forEach((entry) => {
          switch (entry.name) {
            case 'first-contentful-paint':
              newMetrics.fcp = entry.startTime;
              break;
            case 'largest-contentful-paint':
              newMetrics.lcp = entry.startTime;
              break;
            case 'first-input':
              newMetrics.fid = entry.processingStart - entry.startTime;
              break;
            case 'layout-shift':
              newMetrics.cls = (newMetrics.cls || 0) + (entry as any).value;
              break;
          }
        });
        
        setMetrics(prev => ({ ...prev, ...newMetrics } as PerformanceMetrics));
      });

      observer.observe({ entryTypes: ['paint', 'largest-contentful-paint', 'first-input', 'layout-shift'] });

      // 收集其他性能指标
      const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
      if (navigation) {
        setMetrics(prev => ({
          ...prev,
          ttfb: navigation.responseStart - navigation.requestStart,
          fmp: navigation.domContentLoadedEventEnd - navigation.navigationStart,
        } as PerformanceMetrics));
      }

      setLoading(false);
    };

    collectMetrics();
  }, [appId]);

  return { metrics, loading };
};
```

### 5.2 错误监控集成
```typescript
// utils/errorMonitoring.ts
class ErrorMonitoring {
  private appId: string;
  private sourceMapService: SourceMapService;

  constructor(appId: string) {
    this.appId = appId;
    this.sourceMapService = new SourceMapService();
  }

  init() {
    // 监听JavaScript错误
    window.addEventListener('error', (event) => {
      this.reportError({
        type: 'javascript',
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        timestamp: new Date().toISOString(),
      });
    });

    // 监听Promise rejection
    window.addEventListener('unhandledrejection', (event) => {
      this.reportError({
        type: 'promise',
        message: event.reason?.message || 'Unhandled Promise Rejection',
        stack: event.reason?.stack,
        timestamp: new Date().toISOString(),
      });
    });
  }

  private async reportError(error: ErrorReport) {
    try {
      // 尝试映射到源码位置
      const sourceMapping = await this.sourceMapService.mapError(error);
      
      const errorReport = {
        ...error,
        appId: this.appId,
        sourceMapping,
        userAgent: navigator.userAgent,
        url: window.location.href,
        userId: this.getCurrentUserId(),
      };

      // 发送到后端
      await fetch('/api/errors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(errorReport),
      });
    } catch (err) {
      console.error('Failed to report error:', err);
    }
  }

  private getCurrentUserId(): string | null {
    // 从认证状态获取用户ID
    return localStorage.getItem('userId');
  }
}
```

## 6. Source Map集成

### 6.1 Source Map服务
```typescript
// services/sourceMapService.ts
class SourceMapService {
  private sourceMapCache: Map<string, any> = new Map();

  async mapError(error: ErrorReport): Promise<SourceMapMapping | null> {
    try {
      const sourceMap = await this.getSourceMap(error.filename);
      if (!sourceMap) return null;

      const mapping = this.findMapping(sourceMap, error.lineno, error.colno);
      return mapping;
    } catch (err) {
      console.error('Source map mapping failed:', err);
      return null;
    }
  }

  private async getSourceMap(filename: string): Promise<any> {
    if (this.sourceMapCache.has(filename)) {
      return this.sourceMapCache.get(filename);
    }

    try {
      const response = await fetch(`${filename}.map`);
      const sourceMap = await response.json();
      this.sourceMapCache.set(filename, sourceMap);
      return sourceMap;
    } catch (err) {
      console.error('Failed to load source map:', err);
      return null;
    }
  }

  private findMapping(sourceMap: any, line: number, column: number): SourceMapMapping | null {
    // 实现source map解析逻辑
    // 这里需要集成source-map库
    return {
      source: 'src/components/Example.tsx',
      line: 42,
      column: 15,
      name: 'handleClick',
    };
  }
}
```

## 7. 数据可视化实现

### 7.1 实时监控看板
```typescript
// pages/dashboard/RealTimeMonitor.tsx
import React, { useEffect, useState } from 'react';
import { Card, Row, Col, Statistic, Alert } from 'antd';
import { RingChart, TrendChart, GaugeChart } from '@/components/charts';
import { usePerformanceMonitoring } from '@/hooks/usePerformanceMonitoring';

const RealTimeMonitor: React.FC = () => {
  const [alerts, setAlerts] = useState<Alert[]>([]);
  const { metrics, loading } = usePerformanceMonitoring('app-001');

  useEffect(() => {
    // 检查性能指标阈值
    if (metrics) {
      const newAlerts: Alert[] = [];
      
      if (metrics.lcp > 2500) {
        newAlerts.push({
          type: 'warning',
          message: 'LCP超过阈值 (2.5s)',
          description: `当前LCP: ${metrics.lcp.toFixed(2)}ms`,
        });
      }
      
      if (metrics.fid > 100) {
        newAlerts.push({
          type: 'error',
          message: 'FID超过阈值 (100ms)',
          description: `当前FID: ${metrics.fid.toFixed(2)}ms`,
        });
      }
      
      setAlerts(newAlerts);
    }
  }, [metrics]);

  return (
    <div className="real-time-monitor">
      <Row gutter={[16, 16]}>
        <Col span={24}>
          <Card title="实时性能监控">
            {alerts.map((alert, index) => (
              <Alert
                key={index}
                type={alert.type}
                message={alert.message}
                description={alert.description}
                showIcon
                style={{ marginBottom: 16 }}
              />
            ))}
          </Card>
        </Col>
        
        <Col span={8}>
          <Card title="Core Web Vitals">
            <GaugeChart
              data={[
                { name: 'LCP', value: metrics?.lcp || 0, max: 4000 },
                { name: 'FID', value: metrics?.fid || 0, max: 200 },
                { name: 'CLS', value: metrics?.cls || 0, max: 0.25 },
              ]}
            />
          </Card>
        </Col>
        
        <Col span={16}>
          <Card title="性能趋势">
            <TrendChart
              data={[
                { date: '2024-01-01', value: 1200, category: 'LCP' },
                { date: '2024-01-02', value: 1100, category: 'LCP' },
                { date: '2024-01-03', value: 1300, category: 'LCP' },
                // ... 更多数据
              ]}
              seriesField="category"
            />
          </Card>
        </Col>
      </Row>
    </div>
  );
};
```

## 8. 部署和构建配置

### 8.1 Vite配置
```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
    },
  },
  build: {
    sourcemap: true, // 生成source map
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          charts: ['@ant-design/charts', 'echarts'],
          utils: ['lodash', 'dayjs'],
        },
      },
    },
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
      },
    },
  },
});
```

### 8.2 TypeScript配置
```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "module": "ESNext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "exclude": ["node_modules", "dist"]
}
```

这个技术实现方案提供了完整的前端架构设计，包括组件设计、状态管理、API服务、性能监控、Source Map集成等核心功能。所有代码都基于React + TypeScript，并集成了您要求的所有功能特性。
